function [U, L, V, x, A, Ainv] = xfrmToPA(x0)
%#eml

N = size(x0,1);
%%demean the markers.
x = x0 - repmat(mean(x0),N,1);

%% transform the markers into principal axes.
[U L V] = svd(x);
L0 = diag(L);
% get the lambda squared values
Lambda2 = (L0).^2;

if(nargout > 3)
    x = x*V;
    if(nargout > 4)
        for i = 1:N
            A{i} = zeros(6);
            A{i}(1,1) = 1/N + 2*x(i,2)^2/(Lambda2(1) + Lambda2(2)) ...
                + 2*x(i,3)^2/(Lambda2(1) + Lambda2(3)) ...
                - x(i,2)^2*Lambda2(2) / (Lambda2(2) + Lambda2(1))^2 ...
                - x(i,3)^2*Lambda2(3) / (Lambda2(3) + Lambda2(1))^2 ;
            A{i}(1,2) = -2*(x(i,2)*x(i,1)/(Lambda2(2) + Lambda2(1)));
            A{i}(1,3) = -2*(x(i,3)*x(i,1)/(Lambda2(3) + Lambda2(1)));
            A{i}(1,4) = -1*x(i,2)^2*Lambda2(1)/(Lambda2(2) + Lambda2(1))^2;
            A{i}(1,5) = -2*x(i,2)*x(i,3)*Lambda2(1)/((Lambda2(2) + Lambda2(1))*(Lambda2(3) + Lambda2(1)));
            A{i}(1,6) = -1*x(i,3)^2*Lambda2(1)/(Lambda2(3) + Lambda2(1))^2;
            A{i}(2,1) = x(i,1)*x(i,2)*Lambda2(2)/(Lambda2(2) + Lambda2(1))^2 ...
                - x(i,1)*x(i,2)/(Lambda2(2) + Lambda2(1));
            A{i}(2,2) = 1/N + x(i,3)^2/(Lambda2(3) + Lambda2(1)) ...
                + x(i,3)^2/(Lambda2(3) + Lambda2(2)) ...
                + (x(i,2)^2 + x(i,1)^2)/(Lambda2(2) + Lambda2(1)) ...
                - x(i,3)^2 * Lambda2(3) / ((Lambda2(3) + Lambda2(1))*(Lambda2(3) + Lambda2(2)));
            A{i}(2,3) = x(i,3) * x(i,2) * Lambda2(2)/((Lambda2(2) + Lambda2(1)) * (Lambda2(3) + Lambda2(2)))...
                - x(i,3)*x(i,2)/(Lambda2(3) + Lambda2(2));
            A{i}(2,4) = -1*x(i,2)*x(i,1)/(Lambda2(2) + Lambda2(1)) ...
                + x(i,1)*x(i,2)*Lambda2(1)/(Lambda2(2) + Lambda2(1))^2;
            A{i}(2,5) = x(i,1)*x(i,3)*Lambda2(1)/((Lambda2(3) + Lambda2(1))*(Lambda2(2) + Lambda2(1)))...
                -x(i,3)*x(i,1)/(Lambda2(3) + Lambda2(1));
            A{i}(2,6) = 0;
            A{i}(3,1) = -1*x(i,1)*x(i,3)/(Lambda2(3) + Lambda2(1))^2 ...
                + x(i,1)*x(i,3)*Lambda2(3)/(Lambda2(3) + Lambda2(1))^2;
            A{i}(3,2) = -1*x(i,3)*x(i,2)/(Lambda2(3) + Lambda2(2)) ...
                + x(i,2)*x(i,3)*Lambda2(3)/((Lambda2(3) + Lambda2(1))*(Lambda2(3) + Lambda2(2)));
            A{i}(3,3) = 1/N + x(i,2)^2/(Lambda2(2) + Lambda2(1)) ...
                + x(i,1)^2/(Lambda2(3) + Lambda2(1)) ...
                + x(i,2)^2/(Lambda2(3) + Lambda2(2)) ...
                + x(i,3)^2/(Lambda2(3) + Lambda2(1)) ...
                - x(i,2)^2*Lambda2(2)/((Lambda2(2) + Lambda2(1))*(Lambda2(3) + Lambda2(2)));
            A{i}(3,4) = 0;
            A{i}(3,5) = -1*x(i,2)*x(i,1)/(Lambda2(2) + Lambda2(1)) ...
                + x(i,1)*x(i,2)*Lambda2(1)/((Lambda2(2) + Lambda2(1))*(Lambda2(3) + Lambda2(1)));
            A{i}(3,6) = x(i,1)*x(i,3)*Lambda2(1)/(Lambda2(3) + Lambda2(1))^2 ...
                - x(i,3)*x(i,1)/(Lambda2(3) + Lambda2(1));
            A{i}(4,1) = -1*x(i,1)^2*Lambda2(2)/(Lambda2(2) + Lambda2(1))^2;
            A{i}(4,2) = -2*x(i,2)*x(i,1)/(Lambda2(2) + Lambda2(1));
            A{i}(4,3) = -2*x(i,1)*x(i,3)*Lambda2(2)/((Lambda2(3) + Lambda2(2))*(Lambda2(2) + Lambda2(1)));
            A{i}(4,4) = 1/N + 2*x(i,1)^2/(Lambda2(2) + Lambda2(1)) ...
                - x(i,3)^2*Lambda2(3)/(Lambda2(3) + Lambda2(2))^2 ...
                + 2*x(i,3)^2/(Lambda2(3) + Lambda2(2)) ...
                - x(i,1)^2*Lambda2(1)/(Lambda2(2) + Lambda2(1))^2;
            A{i}(4,5) = -2*x(i,3)*x(i,2)/(Lambda2(3) + Lambda2(2));
            A{i}(4,6) = -1*x(i,3)^2*Lambda2(2)/(Lambda2(3) + Lambda2(2))^2;
            A{i}(5,1) = 0;
            A{i}(5,2) = x(i,1)*x(i,3)*Lambda2(3)/((Lambda2(3) + Lambda2(2))*(Lambda2(3) + Lambda2(1))) ...
                -x(i,3)*x(i,1)/(Lambda2(3) + Lambda2(1));
            A{i}(5,3) = x(i,2)*x(i,1)*Lambda2(2)/((Lambda2(2) + Lambda2(1))*(Lambda2(3) + Lambda2(2))) ...
                -x(i,2)*x(i,1)/(Lambda2(2) + Lambda2(1));
            A{i}(5,4) = -1*x(i,3)*x(i,2)/(Lambda2(3) + Lambda2(2)) ...
                + x(i,2)*x(i,3)*Lambda2(3)/(Lambda2(3)+Lambda2(2))^2;
            A{i}(5,5) = 1/N + x(i,1)^2/(Lambda2(2) + Lambda2(1)) ...
                + x(i,2)^2/(Lambda2(3) + Lambda2(2)) ...
                + x(i,3)^2/(Lambda2(3) + Lambda2(2)) ...
                + x(i,1)^2/(Lambda2(3) + Lambda2(1)) ...
                - x(i,1)^2*Lambda2(1)/((Lambda2(2) + Lambda2(1))*(Lambda2(3) + Lambda2(1)));
            A{i}(5,6) = x(i,2)*x(i,3)*Lambda2(2)/(Lambda2(3) + Lambda2(2))^2 ...
                - x(i,3)*x(i,2)/(Lambda2(3) + Lambda2(2));
            A{i}(6,1) = -1*x(i,1)^2*Lambda2(3)/(Lambda2(3) + Lambda2(1))^2;
            A{i}(6,2) = -2*x(i,1)*x(i,2)*Lambda2(3)/((Lambda2(3) + Lambda2(2))*(Lambda2(3) + Lambda2(1)));
            A{i}(6,3) = -2*x(i,3)*x(i,1)/(Lambda2(3) + Lambda2(1));
            A{i}(6,4) = -1*x(i,2)^2 * Lambda2(3)/(Lambda2(3) + Lambda2(2))^2;
            A{i}(6,5) = -2*x(i,3)*x(i,2)/(Lambda2(3) + Lambda2(2));
            A{i}(6,6) = 1/N + 2*x(i,1)^2/(Lambda2(3) + Lambda2(1)) ...
                + 2*x(i,2)^2/(Lambda2(3) + Lambda2(2)) ...
                - x(i,1)^2*Lambda2(1)/(Lambda2(3) + Lambda2(1))^2 ...
                - x(i,2)^2*Lambda2(2)/(Lambda2(3) + Lambda2(2))^2;
            A{i} = eye(6) - A{i};
            if(nargout > 5)
                Ainv{i} = inv(A{i});
            end
        end
    end
end